<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Красивый Чат</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            color: #fff;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            max-height: 95vh;
            background: rgba(45, 45, 45, 0.95);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: rgba(35, 35, 35, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 10;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-item.active {
            background: rgba(0, 132, 255, 0.2);
        }

        .chat-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0084ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            overflow: hidden;
        }

        .chat-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-item-info {
            flex: 1;
            overflow: hidden;
        }

        .chat-item-name {
            font-weight: 500;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-last-message {
            font-size: 0.8em;
            color: #a8a8a8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .new-chat-button {
            margin: 15px;
            padding: 12px;
            background: #0084ff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
        }

        .new-chat-button:hover {
            background: #0073e6;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 15px;
            background: rgba(54, 54, 54, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header h2 {
            color: #fff;
            font-size: 1.2rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu-toggle {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 10px;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            margin-left: 10px;
        }

        .user-id {
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .user-id:hover {
            color: #0084ff;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .user-item-id {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #fff;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            word-wrap: break-word;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.received {
            background: rgba(54, 54, 54, 0.95);
            color: #fff;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .message.sent {
            background: #0084ff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message .user-id {
            font-size: 0.8rem;
            opacity: 0.8;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .message .user-id:hover {
            color: #0084ff;
            opacity: 1;
        }

        .message .timestamp {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            padding: 10px 15px;
            background: rgba(54, 54, 54, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            outline: none;
            font-size: 15px;
            background: rgba(45, 45, 45, 0.95);
            color: #fff;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: #0084ff;
            box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.2);
        }

        button {
            padding: 12px;
            background: #0084ff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
        }

        button:hover {
            background: #0073e6;
        }

        #sendButton {
            width: 48px;
            height: 48px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            font-size: 1.2em;
        }

        .typing-indicator {
            padding: 10px;
            color: #a8a8a8;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* Улучшенный скроллбар */
        .chat-messages::-webkit-scrollbar,
        .chat-list::-webkit-scrollbar,
        .user-list::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .chat-list::-webkit-scrollbar-track,
        .user-list::-webkit-scrollbar-track {
            background: rgba(45, 45, 45, 0.5);
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .chat-list::-webkit-scrollbar-thumb,
        .user-list::-webkit-scrollbar-thumb {
            background: rgba(64, 64, 64, 0.8);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .chat-list::-webkit-scrollbar-thumb:hover,
        .user-list::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 74, 74, 0.9);
        }

        /* Модальное окно для нового чата */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(45, 45, 45, 0.95);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.5em;
            color: #a8a8a8;
        }

        .user-search {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(35, 35, 35, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
        }
        
        /* Медиа-запросы для адаптивного дизайна */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .app-container {
                border-radius: 0;
                max-height: 100vh;
                height: 100vh;
            }
            
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                width: 85%;
                max-width: 300px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .chat-header h2 {
                max-width: 60%;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-input {
                padding: 10px;
            }
            
            #sendButton {
                padding: 0;
                width: 48px;
                height: 48px;
            }
            
            /* Затемнение фона при открытом сайдбаре */
            .sidebar-backdrop {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 5;
            }
            
            .sidebar-backdrop.active {
                display: block;
            }
            
            .message-avatar {
                width: 20px;
                height: 20px;
            }
            
            .chat-header-avatar {
                width: 32px;
                height: 32px;
            }
        }
        
        /* Исправления для iPhone и очень маленьких экранов */
        @media screen and (max-width: 375px) {
            .chat-header {
                padding: 10px;
            }
            
            .chat-input {
                padding: 8px;
            }
            
            input {
                padding: 10px;
            }
            
            #sendButton {
                width: 42px;
                height: 42px;
            }
            
            .chat-messages {
                padding: 10px;
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .profile-button {
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }
        
        .profile-button:hover {
            color: #0084ff;
        }
        
        /* Медиа-запрос для мобильных устройств */
        @media screen and (max-width: 480px) {
            .header-actions {
                gap: 10px;
            }
            
            .profile-button {
                font-size: 1.3rem;
            }
            
            .message {
                max-width: 90%;
            }
            
            .message-header {
                margin-bottom: 3px;
            }
            
            .message-avatar {
                width: 18px;
                height: 18px;
                margin-right: 5px;
            }
            
            .chat-header-avatar {
                width: 28px;
                height: 28px;
            }
            
            .chat-item-icon {
                width: 36px;
                height: 36px;
                min-width: 36px;
            }
            
            .chat-header h2 {
                font-size: 1rem;
                max-width: 120px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .user-id {
                font-size: 0.7rem;
            }
            
            /* Улучшаем отображение кнопок на малых экранах */
            .chat-input {
                padding: 8px;
            }
            
            .input-wrapper {
                flex: 1;
            }
            
            input {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            #sendButton {
                width: 40px;
                height: 40px;
                min-width: 40px;
            }
        }

        /* Улучшение доступности для сенсорных экранов */
        @media (hover: none) {
            .chat-item:active {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .message-header:active {
                opacity: 0.7;
            }
            
            .chat-header-avatar:active {
                opacity: 0.7;
            }
            
            .user-id:active {
                color: #0084ff;
            }
        }

        /* Стили для индикации загрузки */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #a8a8a8;
            font-size: 14px;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #0084ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Стиль для сообщения о требуемом индексе */
        .index-message {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #ffc107;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 13px;
            color: #fff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <button class="new-chat-button" onclick="showNewChatModal()">
                <i class="fas fa-plus"></i>
                Новый чат
            </button>
            <div class="chat-list" id="chatList">
                <div class="chat-item active" data-chat-id="global" onclick="switchChat('global')">
                    <div class="chat-item-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="chat-item-info">
                        <div class="chat-item-name">Глобальный чат</div>
                        <div class="chat-item-last-message">Общий чат для всех</div>
                    </div>
                </div>
                <!-- Личные чаты будут добавляться здесь -->
            </div>
        </div>
        
        <!-- Затемнение фона при открытом боковом меню -->
        <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>
        
        <div class="chat-section">
            <div class="chat-header">
                <div class="chat-header-left">
                    <i class="fas fa-bars menu-toggle" onclick="toggleSidebar()"></i>
                    <!-- Аватарка будет добавлена динамически здесь -->
                    <h2 id="currentChatName">Глобальный чат</h2>
                    <div class="online-indicator"></div>
                </div>
                <div class="header-actions">
                    <a href="profile.html" class="profile-button" title="Мой профиль">
                        <i class="fas fa-user-circle"></i>
                    </a>
                    <div class="user-id">ID: <span id="userId"></span></div>
                </div>
            </div>
            <div class="chat-messages" id="messages"></div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <input type="text" id="messageInput" placeholder="Введите сообщение...">
                </div>
                <button id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания нового чата -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Новый чат</h3>
                <span class="modal-close" onclick="hideNewChatModal()">&times;</span>
            </div>
            <input type="text" class="user-search" placeholder="Поиск пользователя по ID..." 
                   onkeyup="searchUsers(this.value)">
            <div class="user-list" id="userList">
                <!-- Список пользователей будет добавляться здесь -->
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCxypEXHGW58g4kUJ80qJQDSv_jOHsnh4w",
            authDomain: "chat-5fe0a.firebaseapp.com",
            projectId: "chat-5fe0a",
            storageBucket: "chat-5fe0a.firebasestorage.app",
            messagingSenderId: "494037188866",
            appId: "1:494037188866:web:9eadb1d943535e19dd821b",
            measurementId: "G-W2QDT0QKY5"
        };

        // Объявляем db глобально, перед блоком try-catch
        let db;

        // Инициализация Firebase с обработкой ошибок
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Настройка Firestore для более быстрой работы
            db.settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            
            console.log("Firebase успешно инициализирован");
            
            // Проверка соединения с Firebase
            db.collection('users').doc('test').get()
                .then(() => {
                    console.log("Соединение с Firestore установлено");
                    document.querySelector('.online-indicator').style.background = '#4CAF50';
                })
                .catch(error => {
                    console.error("Ошибка подключения к Firestore:", error);
                    document.querySelector('.online-indicator').style.background = 'red';
                    alert("Проблема с подключением к серверу: " + error.message);
                });
        } catch (error) {
            console.error("Ошибка при инициализации Firebase:", error);
            alert("Ошибка при инициализации приложения: " + error.message);
        }

        // Генерация ID пользователя
        const userId = localStorage.getItem('chatUserId') || 
                      'user' + Math.floor(Math.random() * 9999).toString().padStart(4, '0');
        localStorage.setItem('chatUserId', userId);
        document.getElementById('userId').textContent = userId;

        let currentChatId = 'global';
        let unsubscribe = null;

        // Сохранение пользователя в базе данных
        db.collection('users').doc(userId).set({
            userId: userId,
            lastSeen: Date.now()
        }, { merge: true });

        // Кэш для аватаров пользователей
        const userAvatarCache = {};
        
        // Обновленная функция для получения данных пользователя с кэшированием
        function getUserData(userId) {
            // Если данные уже есть в кэше, возвращаем их
            if (userAvatarCache[userId]) {
                return Promise.resolve(userAvatarCache[userId]);
            }
            
            // Иначе получаем из Firestore
            return db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        // Сохраняем в кэше
                        userAvatarCache[userId] = userData;
                        return userData;
                    } else {
                        return null;
                    }
                });
        }
        
        // Функция для предварительной загрузки аватарок в кэш
        function preloadUserAvatars(userIds) {
            const promises = userIds.map(userId => getUserData(userId));
            Promise.all(promises)
                .then(() => console.log('Аватарки пользователей предзагружены'))
                .catch(error => console.error('Ошибка при предзагрузке аватарок:', error));
        }

        // Добавьте глобальную переменную для отслеживания создания индексов
        let indexCreationInProgress = false;

        // Функция для проверки наличия индексов
        function checkIndexes() {
            // Пробуем выполнить запрос, требующий составной индекс
            db.collection('private_messages')
                .where('chatId', '==', 'test')
                .orderBy('timestamp', 'asc')
                .limit(1)
                .get()
                .then(() => {
                    console.log("Индексы для private_messages созданы");
                    indexCreationInProgress = false;
                })
                .catch(error => {
                    if (error.message.includes('requires an index')) {
                        console.log("Индексы для private_messages не созданы");
                        indexCreationInProgress = true;
                    }
                });
        }

        // Исправленная функция для получения личных сообщений
        function getPrivateMessages(chatId) {
            return new Promise((resolve, reject) => {
                db.collection('private_messages')
                    .where('chatId', '==', chatId)
                    .get()
                    .then(snapshot => {
                        const messages = [];
                        snapshot.forEach(doc => {
                            messages.push(doc.data());
                        });
                        
                        // Сортировка по времени
                        messages.sort((a, b) => a.timestamp - b.timestamp);
                        
                        resolve(messages);
                    })
                    .catch(error => {
                        console.error("Ошибка при получении личных сообщений:", error);
                        reject(error);
                    });
            });
        }

        // Функция отправки сообщения
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            messageInput.disabled = true;
            
            const now = Date.now();
            const messageData = {
                text: message,
                userId: userId,
                timestamp: now
            };
            
            console.log("Отправка сообщения:", currentChatId, messageData);
            
            if (currentChatId === 'global') {
                // Глобальный чат
                db.collection('messages').add(messageData)
                    .then(() => {
                        console.log("Сообщение отправлено в глобальный чат");
                        messageInput.value = '';
                        messageInput.disabled = false;
                    })
                    .catch(error => {
                        console.error("Ошибка при отправке в глобальный чат:", error);
                        messageInput.disabled = false;
                        alert("Ошибка при отправке: " + error.message);
                    });
            } else {
                // Личный чат - упрощаем, чтобы найти проблему
                const privateMessage = {
                    text: message,
                    userId: userId,
                    timestamp: now,
                    chatId: currentChatId
                };
                
                console.log("Отправка личного сообщения:", privateMessage);
                
                // Пробуем просто добавить сообщение без обновления чата
                db.collection('private_messages').add(privateMessage)
                    .then(docRef => {
                        console.log("Личное сообщение отправлено, ID:", docRef.id);
                        messageInput.value = '';
                        messageInput.disabled = false;
                        
                        // Теперь обновляем информацию о чате
                        return db.collection('chats').doc(currentChatId).update({
                            lastMessage: message,
                            lastMessageTime: now
                        });
                    })
                    .then(() => {
                        console.log("Информация о чате обновлена");
                    })
                    .catch(error => {
                        console.error("Ошибка при отправке личного сообщения:", error);
                        messageInput.disabled = false;
                        alert("Ошибка при отправке: " + error.message);
                    });
            }
        }

        // Функция для отображения индикатора загрузки
        function showLoadingIndicator() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = `
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <div>Загрузка сообщений...</div>
                </div>
            `;
        }

        // Функция для отображения сообщения о требуемом индексе
        function showIndexMessage() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML += `
                <div class="index-message">
                    <p>⚠️ Для полной работы чата требуется создать индекс в Firebase.</p>
                    <p>Пока индекс создается, используется альтернативный метод загрузки сообщений.</p>
                </div>
            `;
        }

        // Обновленная функция переключения чата
        function switchChat(chatId) {
            console.log("Переключение на чат:", chatId);
            
            // Показываем индикатор загрузки
            showLoadingIndicator();
            
            // Отписываемся от предыдущей подписки
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            
            currentChatId = chatId;
            
            // Очищаем контейнер сообщений
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            // Обновляем название чата и аватарку
            const chatTitle = document.getElementById('currentChatName');
            const chatHeaderLeft = document.querySelector('.chat-header-left');
            
            if (chatId === 'global') {
                chatTitle.textContent = 'Глобальный чат';
                
                // Удаляем аватарку, если она была добавлена ранее
                const existingAvatar = chatHeaderLeft.querySelector('.chat-header-avatar');
                if (existingAvatar) {
                    existingAvatar.remove();
                }
                
                console.log("Загрузка сообщений из глобального чата");
                
                // Попробуем сначала просто загрузить сообщения, а не подписываться на них
                db.collection('messages')
                    .get()
                    .then(snapshot => {
                        console.log("Получено сообщений из глобального чата:", snapshot.size);
                        
                        // Сортируем сообщения по времени
                        const messages = [];
                        snapshot.forEach(doc => {
                            messages.push(doc.data());
                        });
                        
                        messages.sort((a, b) => a.timestamp - b.timestamp);
                        
                        // Очищаем контейнер сообщений
                        messagesContainer.innerHTML = '';
                        
                        // Отображаем сообщения
                        if (messages.length > 0) {
                            messages.forEach(data => {
                                displayMessage(data);
                            });
                        } else {
                            messagesContainer.innerHTML = '<div class="message received" style="align-self: center;">Сообщений пока нет. Напишите первым!</div>';
                        }
                        
                        // Теперь подписываемся на новые сообщения
                        unsubscribe = db.collection('messages')
                            .orderBy('timestamp', 'asc')
                            .onSnapshot(snapshot => {
                                handleMessages(snapshot);
                            }, error => {
                                console.error("Ошибка при получении сообщений:", error);
                            });
                    })
                    .catch(error => {
                        console.error("Ошибка при загрузке сообщений из глобального чата:", error);
                        messagesContainer.innerHTML = '<div class="message received" style="align-self: center;">Ошибка загрузки сообщений. Пожалуйста, перезагрузите страницу.</div>';
                    });
            } else {
                // Находим другого участника чата
                const otherUserId = chatId.split('_').find(id => id !== userId);
                chatTitle.textContent = `Чат с ${otherUserId}`;
                
                // Получаем данные пользователя для отображения аватарки
                getUserData(otherUserId)
                    .then(userData => {
                        // Удаляем предыдущую аватарку, если она есть
                        const existingAvatar = chatHeaderLeft.querySelector('.chat-header-avatar');
                        if (existingAvatar) {
                            existingAvatar.remove();
                        }
                        
                        // Создаем элемент для аватарки
                        const avatarElement = document.createElement('div');
                        avatarElement.className = 'chat-header-avatar';
                        avatarElement.onclick = () => viewUserProfile(otherUserId);
                        
                        let avatarSrc = 'https://via.placeholder.com/150';
                        if (userData && userData.avatarUrl) {
                            avatarSrc = userData.avatarUrl;
                        } else if (userData && userData.avatarBase64) {
                            avatarSrc = userData.avatarBase64;
                        }
                        
                        avatarElement.innerHTML = `<img src="${avatarSrc}" alt="${otherUserId}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';">`;
                        
                        // Добавляем аватарку перед названием чата
                        chatHeaderLeft.insertBefore(avatarElement, chatTitle);
                    })
                    .catch(error => {
                        console.error('Ошибка при получении данных пользователя:', error);
                    });
                
                console.log("Запрос личных сообщений для чата:", chatId);
                
                // Пробуем использовать запрос с индексами
                try {
                    unsubscribe = db.collection('private_messages')
                        .where('chatId', '==', chatId)
                        .orderBy('timestamp', 'asc')
                        .onSnapshot(snapshot => {
                            console.log("Получено личных сообщений:", snapshot.size);
                            handleMessages(snapshot);
                        }, error => {
                            console.error("Ошибка при получении личных сообщений:", error);
                            
                            // Если ошибка связана с индексами, используем альтернативный метод
                            if (error.message.includes('requires an index')) {
                                console.log("Для получения сообщений используем альтернативный метод");
                                
                                // Получаем все сообщения без сортировки
                                getPrivateMessages(chatId)
                                    .then(messages => {
                                        // Очищаем контейнер
                                        messagesContainer.innerHTML = '';
                                        // Отображаем сообщения
                                        messages.forEach(data => {
                                            displayMessage(data);
                                        });
                                    })
                                    .catch(err => {
                                        console.error("Ошибка при использовании альтернативного метода:", err);
                                    });
                            }
                        });
                } catch (error) {
                    console.error("Ошибка при подписке на личные сообщения:", error);
                    
                    // Используем альтернативный метод сразу
                    getPrivateMessages(chatId)
                        .then(messages => {
                            // Очищаем контейнер
                            messagesContainer.innerHTML = '';
                            // Отображаем сообщения
                            messages.forEach(data => {
                                displayMessage(data);
                            });
                        })
                        .catch(err => {
                            console.error("Ошибка при использовании альтернативного метода:", err);
                        });
                }
            }
            
            // Выделяем активный чат
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            // Закрываем сайдбар на мобильных устройствах
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // Обновим функцию handleMessages для лучшей обработки сообщений
        function handleMessages(snapshot) {
            console.log("Получено сообщений:", snapshot.size);
            
            // Если это первая загрузка, очищаем контейнер сообщений
            const messagesContainer = document.getElementById('messages');
            if (messagesContainer.innerHTML.includes('loading-indicator')) {
                messagesContainer.innerHTML = '';
            }
            
            // Обрабатываем каждое изменение
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    displayMessage(data);
                }
            });
            
            // Проверяем, есть ли сообщения
            if (snapshot.size === 0) {
                messagesContainer.innerHTML = '<div class="message received" style="align-self: center;">Сообщений пока нет. Напишите первым!</div>';
            }
        }

        // Улучшенная функция отображения сообщения
        function displayMessage(data) {
            if (!data || !data.userId || !data.text) {
                console.error("Некорректные данные сообщения:", data);
                return;
            }
            
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.userId === userId ? 'sent' : 'received'}`;
            
            const timeString = formatTime(data.timestamp || Date.now());
            const safeText = escapeHtml(data.text);
            
            // Получаем данные пользователя для аватарки
            getUserData(data.userId)
                .then(userData => {
                    let avatarSrc = 'https://via.placeholder.com/150';
                    
                    if (userData && userData.avatarUrl) {
                        avatarSrc = userData.avatarUrl;
                    } else if (userData && userData.avatarBase64) {
                        avatarSrc = userData.avatarBase64;
                    }
                    
                    messageDiv.innerHTML = `
                        <div class="message-header" onclick="viewUserProfile('${data.userId}')">
                            <div class="message-avatar">
                                <img src="${avatarSrc}" alt="${data.userId}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';">
                            </div>
                            <div class="user-id">${data.userId}</div>
                        </div>
                        <div class="message-text">${safeText}</div>
                        <div class="timestamp">${timeString}</div>
                    `;
                    
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(error => {
                    console.error('Ошибка при получении данных пользователя:', error);
                    
                    // Если не удалось получить данные, все равно отображаем сообщение
                    messageDiv.innerHTML = `
                        <div class="message-header" onclick="viewUserProfile('${data.userId}')">
                            <div class="message-avatar">
                                <img src="https://via.placeholder.com/150" alt="${data.userId}">
                            </div>
                            <div class="user-id">${data.userId}</div>
                        </div>
                        <div class="message-text">${safeText}</div>
                        <div class="timestamp">${timeString}</div>
                    `;
                    
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }

        // Обновленная функция добавления чата в список
        function addChatToList(chatId, otherUserId) {
            const chatList = document.getElementById('chatList');
            
            // Проверяем, есть ли уже такой чат в списке
            const existingChat = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (existingChat) {
                return;
            }
            
            // Получаем данные пользователя для отображения
            getUserData(otherUserId)
                .then(userData => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.setAttribute('data-chat-id', chatId);
                    
                    let avatarHtml = `<i class="fas fa-user"></i>`;
                    if (userData && userData.avatarUrl) {
                        avatarHtml = `<img src="${userData.avatarUrl}" alt="${otherUserId}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';"/>`;
                    } else if (userData && userData.avatarBase64) {
                        avatarHtml = `<img src="${userData.avatarBase64}" alt="${otherUserId}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';"/>`;
                    }
                    
                    chatItem.innerHTML = `
                        <div class="chat-item-icon">
                            ${avatarHtml}
                        </div>
                        <div class="chat-item-info">
                            <div class="chat-item-name">Чат с ${otherUserId}</div>
                            <div class="chat-item-last-message"></div>
                        </div>
                    `;
                    
                    chatItem.onclick = () => switchChat(chatId);
                    
                    // Добавляем элемент чата в список
                    chatList.appendChild(chatItem);
                    
                    // Обновляем последнее сообщение, если есть
                    getLastMessageForChat(chatId);
                })
                .catch(error => {
                    console.error('Ошибка при получении данных пользователя:', error);
                    
                    // Создаем элемент чата без аватарки
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.setAttribute('data-chat-id', chatId);
                    
                    chatItem.innerHTML = `
                        <div class="chat-item-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="chat-item-info">
                            <div class="chat-item-name">Чат с ${otherUserId}</div>
                            <div class="chat-item-last-message"></div>
                        </div>
                    `;
                    
                    chatItem.onclick = () => switchChat(chatId);
                    chatList.appendChild(chatItem);
                    
                    // Обновляем последнее сообщение, если есть
                    getLastMessageForChat(chatId);
                });
        }
        
        // Функция для получения последнего сообщения в чате
        function getLastMessageForChat(chatId) {
            if (chatId === 'global') {
                // Для глобального чата
                db.collection('messages')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const lastMessage = snapshot.docs[0].data();
                            updateChatLastMessage(chatId, lastMessage.text);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при получении последнего сообщения:', error);
                        
                        // Альтернативный метод для глобального чата
                        db.collection('messages')
                            .get()
                            .then(snapshot => {
                                if (!snapshot.empty) {
                                    let lastMessage = null;
                                    let maxTimestamp = 0;
                                    
                                    snapshot.forEach(doc => {
                                        const data = doc.data();
                                        if (data.timestamp > maxTimestamp) {
                                            maxTimestamp = data.timestamp;
                                            lastMessage = data;
                                        }
                                    });
                                    
                                    if (lastMessage) {
                                        updateChatLastMessage(chatId, lastMessage.text);
                                    }
                                }
                            })
                            .catch(err => {
                                console.error('Альтернативный метод тоже не сработал:', err);
                            });
                    });
            } else {
                // Пытаемся получить последнее сообщение без запроса требующего индекса
                getPrivateMessages(chatId)
                    .then(messages => {
                        if (messages.length > 0) {
                            // Находим сообщение с максимальным timestamp
                            const lastMessage = messages.reduce((max, msg) => 
                                (msg.timestamp > max.timestamp) ? msg : max, messages[0]);
                            
                            updateChatLastMessage(chatId, lastMessage.text);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при получении последнего сообщения:', error);
                    });
            }
        }
        
        // Функция для перехода на страницу профиля
        function viewUserProfile(userId) {
            window.location.href = `profile.html?userId=${userId}`;
        }

        // Функция для проверки подключения к Firestore
        function checkFirestoreConnection() {
            return db.collection('users').doc(userId).get()
                .then(() => {
                    console.log("Соединение с Firestore установлено");
                    return true;
                })
                .catch(error => {
                    console.error("Ошибка подключения к Firestore:", error);
                    return false;
                });
        }

        // Обновленная функция loadChats для загрузки всех чатов пользователя
        function loadChats() {
            console.log("Загрузка чатов для пользователя:", userId);
            
            // Проверяем соединение с Firestore
            checkFirestoreConnection()
                .then(connected => {
                    if (!connected) {
                        alert("Нет соединения с сервером. Проверьте подключение к интернету и перезагрузите страницу.");
                        return;
                    }
                    
                    // Загружаем личные чаты, в которых пользователь является участником
                    db.collection('chats')
                        .where('participants', 'array-contains', userId)
                        .get()
                        .then(snapshot => {
                            console.log("Получено чатов:", snapshot.size);
                            
                            snapshot.forEach(doc => {
                                const chatData = doc.data();
                                const chatId = doc.id;
                                
                                // Находим ID другого участника
                                const otherUserId = chatData.participants.find(id => id !== userId);
                                if (otherUserId) {
                                    // Добавляем чат в список
                                    addChatToList(chatId, otherUserId);
                                }
                            });
                            
                            // После загрузки всех чатов, переключаемся на глобальный
                            switchChat('global');
                        })
                        .catch(error => {
                            console.error("Ошибка при загрузке чатов:", error);
                            // Всё равно пытаемся загрузить глобальный чат
                            switchChat('global');
                        });
                });
        }

        // Добавляем обработчики сетевых событий
        window.addEventListener('online', () => {
            console.log("Соединение с интернетом восстановлено");
            // Перезагружаем данные
            if (currentChatId) {
                switchChat(currentChatId);
            }
        });

        window.addEventListener('offline', () => {
            console.log("Соединение с интернетом потеряно");
            alert("Соединение с интернетом потеряно. Некоторые функции могут быть недоступны.");
        });

        // Добавляем функцию форматирования времени
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        // Добавляем функцию для безопасного отображения текста
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Функция обновления последнего сообщения в списке чатов
        function updateChatLastMessage(chatId, message) {
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (chatItem) {
                const lastMessageElement = chatItem.querySelector('.chat-item-last-message');
                if (lastMessageElement) {
                    // Ограничиваем длину сообщения
                    const shortMessage = message.length > 30 ? message.substring(0, 30) + '...' : message;
                    lastMessageElement.textContent = shortMessage;
                }
            }
        }

        // Функция для переключения бокового меню на мобильных устройствах
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            sidebar.classList.toggle('active');
            backdrop.classList.toggle('active');
        }

        // Функции для работы с модальным окном нового чата
        function showNewChatModal() {
            document.getElementById('newChatModal').style.display = 'flex';
            document.querySelector('.user-search').value = '';
            document.getElementById('userList').innerHTML = '<div class="user-item">Введите ID пользователя для поиска</div>';
        }

        function hideNewChatModal() {
            document.getElementById('newChatModal').style.display = 'none';
        }

        // Функция поиска пользователей
        function searchUsers(query) {
            const userList = document.getElementById('userList');
            
            if (!query.trim()) {
                userList.innerHTML = '<div class="user-item">Введите ID пользователя для поиска</div>';
                return;
            }
            
            userList.innerHTML = '<div class="user-item">Поиск...</div>';
            
            // Поиск пользователей
            db.collection('users')
                .where('userId', '>=', query)
                .where('userId', '<=', query + '\uf8ff')
                .limit(10)
                .get()
                .then(snapshot => {
                    userList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        userList.innerHTML = '<div class="user-item">Пользователи не найдены</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.userId !== userId) {
                            const userItem = document.createElement('div');
                            userItem.className = 'user-item';
                            
                            let avatarHtml = '<i class="fas fa-user" style="margin-right: 10px;"></i>';
                            if (userData.avatarUrl) {
                                avatarHtml = `<img src="${userData.avatarUrl}" alt="${userData.userId}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';">`;
                            } else if (userData.avatarBase64) {
                                avatarHtml = `<img src="${userData.avatarBase64}" alt="${userData.userId}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';">`;
                            }
                            
                            userItem.innerHTML = `
                                <div class="user-item-id">
                                    ${avatarHtml}
                                    ${userData.userId}
                                </div>
                            `;
                            
                            userItem.onclick = () => {
                                startChatWithUser(userData.userId);
                                hideNewChatModal();
                            };
                            
                            userList.appendChild(userItem);
                        }
                    });
                })
                .catch(error => {
                    console.error("Ошибка при поиске пользователей:", error);
                    userList.innerHTML = '<div class="user-item">Ошибка при поиске</div>';
                });
        }

        // Функция для начала чата с пользователем
        function startChatWithUser(otherUserId) {
            if (otherUserId === userId) return;
            
            // Создаем ID чата (сортируем ID пользователей)
            const chatId = [userId, otherUserId].sort().join('_');
            
            // Проверяем, существует ли уже такой чат
            db.collection('chats').doc(chatId).get()
                .then(doc => {
                    if (!doc.exists) {
                        // Если чата еще нет, создаем его
                        return db.collection('chats').doc(chatId).set({
                            participants: [userId, otherUserId],
                            createdAt: Date.now(),
                            lastMessage: '',
                            lastMessageTime: Date.now()
                        });
                    }
                    return Promise.resolve();
                })
                .then(() => {
                    // Добавляем чат в список и переключаемся на него
                    addChatToList(chatId, otherUserId);
                    switchChat(chatId);
                })
                .catch(error => {
                    console.error("Ошибка при создании чата:", error);
                    alert("Не удалось создать чат: " + error.message);
                });
        }

        // Функция для отправки тестового сообщения (для проверки работы)
        function sendTestMessage() {
            const testMessage = {
                text: "Привет! Это тестовое сообщение. Чат работает!",
                userId: userId,
                timestamp: Date.now()
            };
            
            db.collection('messages').add(testMessage)
                .then(() => {
                    console.log("Тестовое сообщение отправлено");
                })
                .catch(error => {
                    console.error("Ошибка при отправке тестового сообщения:", error);
                });
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Инициализация приложения...");
            
            // Добавляем обработчики событий
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Обновляем статус пользователя
            db.collection('users').doc(userId).update({
                lastSeen: Date.now()
            }).catch(error => {
                console.error("Ошибка при обновлении статуса:", error);
            });
            
            // Загружаем чаты
            loadChats();
            
            // Проверяем наличие индексов
            checkIndexes();
        });
    </script>
</body>
</html>