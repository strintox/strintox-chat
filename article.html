<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strintox News - Статья</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Запрет копирования текста и защита контента */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Unified header design for all Strintox sections */
        header {
            background-color: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            margin: 15px 20px;
            padding: 15px 20px;
            border: 1px solid var(--border-color);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            gap: 10px;
        }
        
        .logo i {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .logo h1 {
            color: var(--text-color);
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-link-button, .weather-link, .news-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--button-bg);
            color: var(--button-text);
            padding: 8px 14px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: var(--button-shadow);
        }
        
        .admin-link-button:hover, .weather-link:hover, .news-link:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }
        
        .profile-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--button-bg);
            border: none;
            color: var(--button-text);
            font-size: 1.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: var(--button-shadow);
        }
        
        .profile-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }
        
        /* Theme switch styling */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .theme-icon {
            color: var(--text-color);
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--slider-bg);
            transition: .4s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .slider.round {
            border-radius: 24px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }
        
        /* Link styling */
        .weather-link, .news-link {
            color: var(--button-text);
        }
        
        .weather-link i {
            color: #ffac33;
            font-size: 1.1rem;
        }
        
        .news-link i {
            color: #4fc3f7;
            font-size: 1.1rem;
        }
        
        /* Улучшенные стили для страницы статьи */
        .article-container {
            max-width: 850px;
            margin: 30px auto;
            padding: 0 15px;
        }
        
        .article {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 25px 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .article-header {
            margin-bottom: 25px;
        }
        
        .article-title {
            font-size: 1.8rem;
            color: var(--text-color);
            margin-bottom: 20px;
            line-height: 1.3;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }
        
        .article-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            color: var(--secondary-text-color);
            font-size: 0.95rem;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .article-author, .article-date {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .article-author i, .article-date i {
            color: var(--primary-color);
        }
        
        .article-content {
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--text-color);
            white-space: pre-line;
        }
        
        .article-content p {
            margin-bottom: 16px;
        }
        
        .article-actions {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .article-actions .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
            width: 100%;
            max-width: 250px;
        }
        
        .article-actions .btn-secondary:hover {
            transform: translateY(-2px);
        }
        
        /* Улучшенные стили для комментариев */
        .comments-section {
            margin-top: 40px;
        }
        
        .comments-header {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .comments-header h2 {
            font-size: 1.5rem;
            color: var(--text-color);
            font-weight: 600;
            margin: 0;
        }
        
        .comments-header i {
            color: var(--primary-color);
        }
        
        .comments-count {
            color: var(--secondary-text-color);
            font-size: 1rem;
            font-weight: normal;
        }
        
        .comments-list {
            margin-bottom: 25px;
        }
        
        .comment {
            background-color: var(--light-bg);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .comment:hover {
            transform: translateY(-3px);
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .comment-author {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .comment-date {
            font-size: 0.85rem;
            color: var(--secondary-text-color);
        }
        
        .comment-text {
            color: var(--text-color);
            line-height: 1.6;
            font-size: 1rem;
        }
        
        .comment-form {
            background-color: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .comment-form-title {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--text-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .comment-form-title i {
            color: var(--primary-color);
        }
        
        .comment-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            margin-bottom: 15px;
            resize: vertical;
            transition: all 0.2s;
        }
        
        .comment-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 145, 234, 0.2);
        }
        
        .comment-submit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .comment-submit-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .login-to-comment {
            background-color: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .login-to-comment p {
            margin-bottom: 20px;
            color: var(--secondary-text-color);
            font-size: 1rem;
        }
        
        .login-to-comment .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 25px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
            width: 100%;
            max-width: 250px;
        }
        
        .login-to-comment .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .no-comments {
            text-align: center;
            padding: 30px 20px;
            color: var(--secondary-text-color);
            background-color: var(--light-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .no-comments i {
            font-size: 2.2rem;
            margin-bottom: 12px;
            opacity: 0.7;
            color: var(--border-color);
        }
        
        .no-comments p {
            font-size: 1.05rem;
            color: var(--secondary-text-color);
        }
        
        /* Улучшенные стили для удаления комментариев */
        .delete-comment-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .delete-comment-btn:hover {
            background-color: #c0392b;
        }
        
        /* Улучшенные стили для модального окна авторизации */
        .auth-prompt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .auth-prompt-modal.active {
            display: flex;
        }
        
        .auth-prompt-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            animation: slideDown 0.3s;
        }
        
        .auth-prompt-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        .auth-prompt-title i {
            color: var(--primary-color);
            margin-right: 8px;
        }
        
        .auth-prompt-message {
            margin-bottom: 20px;
            color: var(--secondary-text-color);
            line-height: 1.5;
            font-size: 1rem;
        }
        
        .auth-prompt-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .auth-prompt-actions .btn-primary,
        .auth-prompt-actions .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
            width: 100%;
        }
        
        .auth-prompt-actions .btn-primary:hover,
        .auth-prompt-actions .btn-secondary:hover {
            transform: translateY(-2px);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        
        .close-btn:hover {
            color: var(--text-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Улучшенные стили для индикатора загрузки */
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            color: var(--secondary-text-color);
        }
        
        .loading-indicator i {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        .loading-indicator p {
            font-size: 1.05rem;
        }
        
        /* Стили для сообщения об ошибке */
        .error-message {
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 12px;
            padding: 25px 20px;
            text-align: center;
            color: #c0392b;
            margin: 20px 0;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .error-message i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #e74c3c;
        }
        
        .error-message h2 {
            margin-bottom: 12px;
            color: #c0392b;
            font-size: 1.4rem;
        }
        
        .error-message p {
            margin-bottom: 20px;
            color: #c0392b;
            font-size: 1.05rem;
        }
        
        .error-message .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
            width: 100%;
            max-width: 250px;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                padding: 15px 10px;
                gap: 15px;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }
            
            .logo h1 {
                font-size: 1.5rem;
            }
            
            .article-container {
                padding: 0 12px;
                margin: 20px auto;
            }
            
            .article {
                padding: 20px 15px;
            }
            
            .article-title {
                font-size: 1.5rem;
            }
            
            .article-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .article-content {
                font-size: 1rem;
                line-height: 1.6;
            }
            
            .article-actions .btn-secondary {
                width: 100%;
                max-width: none;
            }
            
            .comments-header h2 {
                font-size: 1.3rem;
            }
        }
        
        /* Дополнительные стили для очень маленьких экранов */
        @media (max-width: 480px) {
            .container {
                padding: 0;
            }
            
            .article {
                padding: 15px 12px;
                border-radius: 10px;
            }
            
            .article-title {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            .article-content {
                font-size: 0.95rem;
            }
            
            .comment {
                padding: 15px 12px;
            }
            
            .comment-text {
                font-size: 0.95rem;
            }
            
            .comment-form {
                padding: 15px 12px;
            }
            
            .comment-submit-btn, 
            .login-to-comment .btn-primary {
                padding: 12px 20px;
                font-size: 0.95rem;
            }
            
            .auth-prompt-content {
                padding: 20px 15px;
            }
            
            .auth-prompt-title {
                font-size: 1.1rem;
            }
            
            .auth-prompt-message {
                font-size: 0.95rem;
            }
            
            .auth-prompt-actions .btn-primary,
            .auth-prompt-actions .btn-secondary {
                padding: 12px 16px;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <a href="news.html" class="logo">
                    <i class="fas fa-newspaper"></i>
                    <h1>Strintox News</h1>
                </a>
                <div class="header-controls">
                    <a href="index.html" class="weather-link">
                        <i class="fas fa-cloud-sun"></i> Strintox Weather
                    </a>
                    <a href="news.html" class="news-link">
                        <i class="fas fa-newspaper"></i> Все новости
                    </a>
                    <a href="admin.html" class="admin-link-button">
                        <i class="fas fa-lock"></i> Админ-панель
                    </a>
                    <button id="profile-button" class="profile-button">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <div class="theme-switch-wrapper">
                        <span class="theme-icon"><i class="fas fa-sun"></i></span>
                        <label class="theme-switch">
                            <input type="checkbox" id="theme-toggle" onclick="toggleTheme()">
                            <span class="slider round"></span>
                        </label>
                        <span class="theme-icon"><i class="fas fa-moon"></i></span>
                    </div>
                </div>
            </div>
        </header>

        <main class="article-container">
            <div id="article-content" class="article">
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Загрузка статьи...</p>
                </div>
            </div>
            
            <div class="comments-section">
                <div class="comments-header">
                    <h2><i class="fas fa-comments"></i> Комментарии</h2>
                    <span id="comments-count" class="comments-count">(0)</span>
                </div>
                
                <div id="comments-list" class="comments-list">
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Загрузка комментариев...</p>
                    </div>
                </div>
                
                <!-- Форма для добавления комментария (для авторизованных пользователей) -->
                <div id="comment-form-container" class="comment-form" style="display: none;">
                    <h3 class="comment-form-title"><i class="fas fa-comment"></i> Оставить комментарий</h3>
                    <form id="comment-form">
                        <textarea id="comment-text" class="comment-textarea" placeholder="Введите ваш комментарий..." required></textarea>
                        <button type="submit" class="comment-submit-btn">
                            <i class="fas fa-paper-plane"></i> Отправить комментарий
                        </button>
                    </form>
                </div>
                
                <!-- Предложение войти (для гостей) -->
                <div id="login-to-comment" class="login-to-comment">
                    <p>Чтобы оставить комментарий, необходимо авторизоваться</p>
                    <button id="login-prompt-btn" class="btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Войти для комментирования
                    </button>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 • Strintox Weather</p>
        </footer>
    </div>
    
    <!-- Модальное окно авторизации -->
    <div id="auth-prompt-modal" class="auth-prompt-modal">
        <div class="auth-prompt-content">
            <div class="auth-prompt-title">
                <span><i class="fas fa-user-lock"></i> Требуется авторизация</span>
                <button id="close-auth-prompt" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="auth-prompt-message">
                Для оставления комментариев необходимо войти в систему. Для входа в админ-панель используйте email <strong>strintox@gmail.com</strong> и соответствующий пароль.
            </div>
            <div class="auth-prompt-actions">
                <a href="admin.html" class="btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Перейти к входу
                </a>
                <button id="cancel-auth-prompt" class="btn-secondary">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let db, auth;
        let isAdmin = false;
        let lastCommentTime = 0; // Для ограничения комментариев
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAAdu7bWt9F2GF1W9qEzfc2f_y6LCqMM14",
            authDomain: "strintox-3a2b8.firebaseapp.com",
            projectId: "strintox-3a2b8",
            storageBucket: "strintox-3a2b8.appspot.com",
            messagingSenderId: "12688530154",
            appId: "1:12688530154:web:da86782e5c3261c6c35593",
            measurementId: "G-WVB4V2T51Y"
        };

        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            db = firebase.firestore();
            auth = firebase.auth();
            
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            showError('Firebase initialization failed: ' + error.message);
        }
        
        // Запрет копирования текста и контекстного меню
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('keydown', function(e) {
            // Блокируем Ctrl+C, Ctrl+X, Ctrl+V, Ctrl+A
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'x' || e.key === 'a')) {
                e.preventDefault();
                return false;
            }
        });
        
        // Проверяем статус администратора
        function checkAdminStatus(userId) {
            const user = auth.currentUser;
            // Проверяем, что текущий пользователь имеет email strintox@gmail.com
            if (user && user.email === 'strintox@gmail.com') {
                isAdmin = true;
                console.log("Admin status: true - strintox@gmail.com");
                return Promise.resolve(true);
            } else {
                isAdmin = false;
                console.log("Admin status: false - not strintox@gmail.com");
                return Promise.resolve(false);
            }
        }
        
        // При загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем ID статьи из URL для загрузки комментариев
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');
            
            // Загружаем статью
            loadArticle();
            
            // Загружаем комментарии после загрузки статьи
            if (articleId) {
                loadComments(articleId);
            }
            
            // Проверяем авторизацию пользователя
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    document.querySelectorAll('.login-to-comment').forEach(el => {
                        el.style.display = 'none';
                    });
                    document.querySelectorAll('.comment-form').forEach(el => {
                        el.style.display = 'block';
                    });
                    
                    // Проверяем статус администратора
                    checkAdminStatus(user.uid).then(isAdmin => {
                        // Показываем кнопки удаления для всех комментариев, если пользователь - админ
                        if (isAdmin) {
                            document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                                btn.style.display = 'block';
                            });
                        }
                    });
                } else {
                    document.querySelectorAll('.login-to-comment').forEach(el => {
                        el.style.display = 'block';
                    });
                    document.querySelectorAll('.comment-form').forEach(el => {
                        el.style.display = 'none';
                    });
                }
            });
            
            // Настраиваем обработчик отправки комментария
            const commentForm = document.getElementById('comment-form');
            if (commentForm) {
                commentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addComment();
                });
            }
            
            // Настраиваем обработчик кнопки входа
            const loginPromptBtn = document.getElementById('login-prompt-btn');
            if (loginPromptBtn) {
                loginPromptBtn.addEventListener('click', function() {
                    showAuthPrompt();
                });
            }
            
            // Настраиваем обработчики закрытия модального окна
            const closeAuthPrompt = document.getElementById('close-auth-prompt');
            const cancelAuthPrompt = document.getElementById('cancel-auth-prompt');
            
            if (closeAuthPrompt) {
                closeAuthPrompt.addEventListener('click', function() {
                    document.getElementById('auth-prompt-modal').classList.remove('active');
                });
            }
            
            if (cancelAuthPrompt) {
                cancelAuthPrompt.addEventListener('click', function() {
                    document.getElementById('auth-prompt-modal').classList.remove('active');
                });
            }
        });
        
        // Функция отправки комментария с ограничением в 1 минуту
        function addComment() {
            const user = auth.currentUser;
            if (!user) {
                showAuthModal();
                return;
            }
            
            const commentText = document.getElementById('comment-text').value.trim();
            if (!commentText) {
                alert('Пожалуйста, введите текст комментария');
                return;
            }
            
            // Проверяем ограничение в 1 минуту
            const now = Date.now();
            if (now - lastCommentTime < 60000) { // 60000 мс = 1 минута
                const remainingSeconds = Math.ceil((60000 - (now - lastCommentTime)) / 1000);
                alert(`Вы можете оставить следующий комментарий через ${remainingSeconds} секунд`);
                return;
            }
            
            // Получаем ID статьи из URL
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');
            
            if (!articleId) {
                alert('Ошибка: ID статьи не найден');
                return;
            }
            
            // Отключаем кнопку отправки
            const submitButton = document.querySelector('.comment-submit-btn');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
            
            // Создаем комментарий
            const commentData = {
                text: commentText,
                userId: user.uid,
                authorName: user.displayName || user.email.split('@')[0],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Сохраняем комментарий
            db.collection('news').doc(articleId).collection('comments').add(commentData)
                .then(() => {
                    // Очищаем поле комментария
                    document.getElementById('comment-text').value = '';
                    
                    // Обновляем время последнего комментария
                    lastCommentTime = Date.now();
                    
                    // Обновляем список комментариев
                    loadComments(articleId);
                    
                    // Восстанавливаем кнопку
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Отправить';
                })
                .catch(error => {
                    console.error("Error adding comment:", error);
                    alert('Ошибка при отправке комментария: ' + error.message);
                    
                    // Восстанавливаем кнопку
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Отправить';
                });
        }
        
        // Функция удаления комментария с проверкой прав
        function deleteComment(commentId) {
            const user = auth.currentUser;
            if (!user) {
                alert('Для удаления комментария необходимо авторизоваться');
                return;
            }
            
            // Получаем ID статьи из URL
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');
            
            if (!articleId) {
                alert('Ошибка: ID статьи не найден');
                return;
            }
            
            // Получаем комментарий для проверки прав
            db.collection('news').doc(articleId).collection('comments').doc(commentId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('Ошибка: комментарий не найден');
                        return;
                    }
                    
                    const comment = doc.data();
                    
                    // Проверяем права на удаление (свой комментарий или админ)
                    if (comment.userId === user.uid || isAdmin) {
                        if (confirm('Вы уверены, что хотите удалить этот комментарий?')) {
                            // Удаляем комментарий
                            db.collection('news').doc(articleId).collection('comments').doc(commentId).delete()
                                .then(() => {
                                    // Обновляем список комментариев
                                    loadComments(articleId);
                                })
                                .catch(error => {
                                    console.error("Error deleting comment:", error);
                                    alert('Ошибка при удалении комментария: ' + error.message);
                                });
                        }
                    } else {
                        alert('У вас нет прав на удаление этого комментария');
                    }
                })
                .catch(error => {
                    console.error("Error getting comment:", error);
                    alert('Ошибка при получении комментария: ' + error.message);
                });
        }
        
        // Загрузка комментариев с учетом прав администратора
        function loadComments(articleId) {
            console.log('Loading comments for article ID:', articleId);
            
            const commentsContainer = document.getElementById('comments-list');
            if (!commentsContainer) {
                console.error('Comments container not found');
                return;
            }
            
            commentsContainer.innerHTML = '<div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i> Загрузка комментариев...</div>';
            
            // Обновляем счетчик комментариев
            const commentsCount = document.getElementById('comments-count');
            if (commentsCount) {
                commentsCount.textContent = '(загрузка...)';
            }
            
            try {
                db.collection('news').doc(articleId).collection('comments')
                    .orderBy('createdAt', 'desc')
                    .get()
                    .then(snapshot => {
                        if (snapshot.empty) {
                            commentsContainer.innerHTML = '<div class="no-comments"><i class="fas fa-comments"></i><p>Комментариев пока нет. Будьте первым!</p></div>';
                            
                            if (commentsCount) {
                                commentsCount.textContent = '(0)';
                            }
                            return;
                        }
                        
                        const user = auth.currentUser;
                        let html = '';
                        let commentCounter = 0;
                        
                        snapshot.forEach(doc => {
                            commentCounter++;
                            const comment = doc.data();
                            
                            // Защита от некорректных данных комментариев
                            if (!comment) {
                                console.error('Empty comment data for document:', doc.id);
                                return;
                            }
                            
                            let dateStr = 'Без даты';
                            
                            try {
                                if (comment.createdAt) {
                                    const date = comment.createdAt.toDate ? comment.createdAt.toDate() : 
                                        comment.createdAt.seconds ? new Date(comment.createdAt.seconds * 1000) : 
                                        new Date(comment.createdAt);
                                        
                                    dateStr = date.toLocaleDateString('ru-RU', {
                                        day: 'numeric', 
                                        month: 'long', 
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                }
                            } catch (e) {
                                console.error('Error formatting date for comment:', e);
                            }
                            
                            // Определяем, может ли пользователь удалить этот комментарий
                            const canDelete = user && (isAdmin || (comment.userId === user.uid));
                            
                            html += `
                                <div class="comment">
                                    <div class="comment-header">
                                        <div class="comment-author">${comment.authorName || 'Пользователь'}</div>
                                        <div class="comment-date">${dateStr}</div>
                                    </div>
                                    <div class="comment-content">${comment.text || ''}</div>
                                    <div class="comment-actions">
                                        <button class="delete-comment-btn" onclick="deleteComment('${doc.id}')" style="display: ${canDelete ? 'block' : 'none'}">
                                            <i class="fas fa-trash"></i> Удалить
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        commentsContainer.innerHTML = html;
                        
                        // Обновляем счетчик комментариев
                        if (commentsCount) {
                            commentsCount.textContent = `(${commentCounter})`;
                        }
                        
                        // Обновляем видимость кнопок удаления
                        if (user && isAdmin) {
                            document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                                btn.style.display = 'block';
                            });
                        }
                        
                        console.log(`Loaded ${commentCounter} comments successfully`);
                    })
                    .catch(error => {
                        console.error("Error loading comments:", error);
                        commentsContainer.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Ошибка загрузки комментариев: ${error.message}</p>
                                <button class="btn-primary" onclick="loadComments('${articleId}')">
                                    <i class="fas fa-sync"></i> Попробовать снова
                                </button>
                            </div>
                        `;
                    });
            } catch (error) {
                console.error("Unexpected error in loadComments:", error);
                commentsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Неожиданная ошибка: ${error.message}</p>
                        <button class="btn-primary" onclick="loadComments('${articleId}')">
                            <i class="fas fa-sync"></i> Попробовать снова
                        </button>
                    </div>
                `;
            }
        }

        // Функция загрузки статьи
        function loadArticle() {
            const articleContainer = document.getElementById('article-content');
            articleContainer.innerHTML = `
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Загрузка статьи...</p>
                </div>
            `;
            
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');
            
            if (!articleId) {
                showError('Не указан ID статьи');
                return;
            }
            
            console.log('Загрузка статьи с ID:', articleId);
            
            db.collection('news').doc(articleId).get()
                .then(doc => {
                    if (!doc.exists) {
                        showError('Статья не найдена');
                        return;
                    }
                    
                    const articleData = doc.data();
                    displayArticle(articleData);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке статьи:', error);
                    showError('Ошибка при загрузке статьи: ' + error.message);
                });
        }

        // Функция отображения статьи
        function displayArticle(data) {
            const articleContainer = document.getElementById('article-content');
            
            // Форматирование даты
            let date;
            if (data.createdAt) {
                if (data.createdAt.toDate) {
                    date = data.createdAt.toDate();
                } else if (data.createdAt.seconds) {
                    date = new Date(data.createdAt.seconds * 1000);
                } else {
                    date = new Date(data.createdAt);
                }
            } else {
                date = new Date();
            }
            
            const formattedDate = date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            // Формируем HTML статьи
            articleContainer.innerHTML = `
                <div class="article-header">
                    <h1 class="article-title">${data.title || 'Без заголовка'}</h1>
                    <div class="article-meta">
                        <span class="article-author"><i class="fas fa-user"></i> ${data.author || 'Администратор'}</span>
                        <span class="article-date"><i class="fas fa-calendar"></i> ${formattedDate}</span>
                    </div>
                </div>
                <div class="article-content">
                    ${formatArticleContent(data.content)}
                </div>
                <div class="article-actions">
                    <a href="news.html" class="btn-secondary">
                        <i class="fas fa-arrow-left"></i> Назад к новостям
                    </a>
                </div>
            `;
            
            // После отображения статьи загружаем комментарии
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');
            if (articleId) {
                loadComments(articleId);
            }
        }

        // Функция форматирования содержимого статьи
        function formatArticleContent(content) {
            if (!content) return '<p>Содержание отсутствует</p>';
            
            // Заменяем переносы строк на </p><p>
            return `<p>${content.replace(/\n/g, '</p><p>')}</p>`;
        }

        // Показать модальное окно с запросом на вход
        function showAuthPrompt() {
            const modal = document.getElementById('auth-prompt-modal');
            modal.classList.add('active');
        }

        // Показать ошибку загрузки статьи
        function showError(message) {
            const articleContainer = document.getElementById('article-content');
            articleContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h2>Ошибка</h2>
                    <p>${message}</p>
                    <a href="news.html" class="btn-secondary">
                        <i class="fas fa-arrow-left"></i> Вернуться к новостям
                    </a>
                </div>
            `;
        }

        // Функция переключения темы
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.checked = newTheme === 'dark';
            }
            
            return false;
        }

        // При загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Применяем сохраненную тему
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.checked = savedTheme === 'dark';
            }
        });
    </script>
</body>
</html> 